# Ambia iOS Native - Ambient Intelligence System

Complete iOS native app with **Live Activities**, **Dynamic Island**, and **Push Notifications** — all dynamically generated by Claude AI with **NO HARDCODING**.

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                         CLAUDE AI                                │
│              (Detects time-sensitive moments)                    │
└──────────────────────┬──────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                    AWS Lambda (Every 1 min)                      │
│  • Analyzes user context (time, calendar, patterns)             │
│  • Calls Claude API to detect ambient events                    │
│  • Stores events in ambient_events table                        │
└──────────────────────┬──────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Backend API (Node.js/MySQL)                    │
│  GET  /ambient/events/:userId                                   │
│  POST /ambient/devices/register                                 │
│  POST /ambient/events/:eventId/interact                         │
└──────────────────────┬──────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                      iOS Native App                              │
│  • Live Activities (ongoing events like travel, deliveries)     │
│  • Dynamic Island (glanceable updates on iPhone 14 Pro+)        │
│  • Push Notifications (time-sensitive alerts)                   │
│  • Dynamic rendering - NO HARDCODED event types!                │
└─────────────────────────────────────────────────────────────────┘
```

## Key Features

### 1. Dynamic Event Generation (NO HARDCODING!)

Claude can generate **ANY type of event** without pre-coded templates:

```json
{
  "event_type": "live_activity",
  "title": "Amtrak to NYC",
  "data": {
    "train": "Northeast Regional 190",
    "platform": "Track 7",
    "departure_time": "3:45 PM",
    "travel_time_mins": 18
  }
}
```

The iOS app **dynamically renders** any data structure - no hardcoded event types needed!

### 2. Live Activities

Persistent, real-time updates on lock screen and Dynamic Island.

**Example Use Cases:**
- Train/flight departures with platform info
- Package delivery windows
- Food delivery tracking
- Timer countdowns
- Event check-ins

### 3. Dynamic Island (iPhone 14 Pro+)

Three display states, all dynamically generated:

- **Compact**: Small pill-shaped notification
- **Minimal**: Tiny circular indicator (when multiple activities active)
- **Expanded**: Full interactive view with dynamic data grid

### 4. Push Notifications

Time-sensitive notifications generated by Claude when moments deserve immediate attention.

## Project Structure

```
ios_native/
├── AmbiaApp/
│   ├── Models/
│   │   └── AmbientEvent.swift          # Data models with AnyCodable for dynamic JSON
│   ├── Services/
│   │   ├── AmbiaAPIClient.swift        # Backend API communication
│   │   ├── LiveActivityManager.swift   # ActivityKit lifecycle management
│   │   └── NotificationManager.swift   # APNs registration and handling
│   ├── Views/
│   │   └── ContentView.swift           # Dynamic event rendering view
│   └── AmbiaApp.swift                  # Main app entry point
│
└── AmbiaWidget/
    ├── AmbiaWidgetBundle.swift
    └── AmbiaLiveActivity.swift         # Widget Extension with Dynamic Island
```

## Setup Instructions

### 1. Xcode Project Setup

1. Open Xcode and create a new iOS App project:
   - **Product Name**: Ambia
   - **Organization Identifier**: com.ambia
   - **Interface**: SwiftUI
   - **Language**: Swift
   - **Minimum Deployment**: iOS 16.1+

2. Add all files from `ios_native/AmbiaApp/` to the main app target

3. Create a Widget Extension:
   - File > New > Target > Widget Extension
   - **Product Name**: AmbiaWidget
   - **Include Live Activity**: YES
   - Add files from `ios_native/AmbiaWidget/`

### 2. Info.plist Configuration

Add to your main app's `Info.plist`:

```xml
<key>NSSupportsLiveActivities</key>
<true/>
<key>UIBackgroundModes</key>
<array>
    <string>remote-notification</string>
</array>
```

### 3. Capabilities

Enable in Xcode > Signing & Capabilities:

- [x] Push Notifications
- [x] Background Modes > Remote notifications

### 4. Backend Configuration

Update `AmbiaAPIClient.swift` line 21:

```swift
private let baseURL = "https://your-backend-url.com/api"
```

### 5. Run the Migration

Ensure the database migration is applied:

```bash
cd /Users/jacobkaplan/ambia/database
# Apply migration 002_ambient_events.sql
```

### 6. Deploy Claude Lambda

The Lambda should already be deployed and running every 1 minute to detect ambient events.

## Usage

### Starting a Live Activity

The app automatically starts Live Activities when Claude generates an event with `event_type: "live_activity"`:

```swift
// Automatically handled by EventStore.fetchEvents()
if event.eventType == .liveActivity {
    try await LiveActivityManager.shared.startActivity(for: event)
}
```

### Dynamic Rendering

The `DynamicEventCard` and `DynamicDataGrid` components automatically render **ANY** data structure:

```swift
// NO HARDCODING - iterates over any keys
ForEach(Array(event.data.keys.sorted()), id: \.self) { key in
    HStack {
        Text(formatKey(key))           // "Departure Time"
        Spacer()
        Text(valueToString(value))     // "3:45 PM"
    }
}
```

### Example Events Claude Can Generate

**Amtrak Departure:**
```json
{
  "title": "Amtrak to NYC",
  "data": {
    "train": "Northeast Regional 190",
    "platform": "Track 7",
    "departure_time": "3:45 PM",
    "travel_time_mins": 18,
    "status": "On Time"
  },
  "icon": "train.side.front.car",
  "color": "#4A90E2"
}
```

**Package Delivery:**
```json
{
  "title": "UPS Delivery",
  "data": {
    "carrier": "UPS",
    "tracking": "1Z999AA10123456784",
    "delivery_window": "2:00 PM - 6:00 PM",
    "packages": 2
  },
  "icon": "shippingbox.fill",
  "color": "#FF9500"
}
```

**Timer:**
```json
{
  "title": "Pasta Timer",
  "data": {
    "remaining_seconds": 180,
    "started_at": "3:42 PM"
  },
  "icon": "timer",
  "color": "#FF3B30"
}
```

## Testing

### Test with Local Notifications

Use the `NotificationManager` to schedule test notifications:

```swift
NotificationManager.shared.scheduleLocalNotification(
    title: "Test Event",
    body: "This is a test ambient event",
    timeInterval: 5
)
```

### Test Live Activities

Manually start a Live Activity:

```swift
let testEvent = AmbientEvent(
    id: "test-123",
    userId: "test",
    eventType: .liveActivity,
    priority: .high,
    title: "Test Activity",
    subtitle: "Testing Dynamic Island",
    body: nil,
    data: [
        "field1": AnyCodable("Value 1"),
        "field2": AnyCodable(42)
    ],
    icon: "info.circle",
    color: "#007AFF",
    imageUrl: nil,
    startTime: Date(),
    endTime: Date().addingTimeInterval(3600),
    validUntil: Date().addingTimeInterval(3600),
    status: .pending,
    confidenceScore: 0.9,
    shownAt: nil,
    interactedAt: nil,
    dismissedAt: nil,
    createdAt: Date()
)

Task {
    try await LiveActivityManager.shared.startActivity(for: testEvent)
}
```

## API Integration

### Fetching Events

```swift
let events = try await AmbiaAPIClient.shared.fetchActiveEvents(
    for: userId,
    type: .liveActivity  // Optional filter
)
```

### Registering Device for Push Notifications

```swift
await NotificationManager.shared.registerDeviceToken(
    deviceToken,
    userId: userId
)
```

### Tracking Interactions

```swift
try await AmbiaAPIClient.shared.trackInteraction(
    eventId: event.id,
    userId: userId,
    interactionType: .tap
)
```

## Dynamic Island Configuration

The `AmbiaLiveActivity.swift` includes all three Dynamic Island states:

### Compact (left + right)
```swift
compactLeading: { Image(systemName: icon) }
compactTrailing: { Text(value) }
```

### Minimal (single icon)
```swift
minimal: { Image(systemName: icon) }
```

### Expanded (full interactive view)
```swift
DynamicIslandExpandedRegion(.leading) { Icon }
DynamicIslandExpandedRegion(.trailing) { Priority }
DynamicIslandExpandedRegion(.center) { Title }
DynamicIslandExpandedRegion(.bottom) { Dynamic Data Grid }
```

## Requirements

- iOS 16.1+ (for Live Activities)
- iPhone 14 Pro+ (for Dynamic Island)
- Xcode 15+
- Swift 5.9+
- Active Apple Developer account (for Push Notifications)

## Next Steps

1. **APNs Certificate**: Generate APNs certificate in Apple Developer portal
2. **Authentication**: Replace `"test-user-id"` with actual user authentication
3. **Production URL**: Update `baseURL` in `AmbiaAPIClient.swift`
4. **App Store**: Configure App Store Connect for push notifications

## Architecture Principles

### NO HARDCODING
- Claude generates ANY event structure
- iOS app dynamically renders ANY data
- No pre-coded event types or templates

### Ambient Intelligence
- Events appear when valuable and time-sensitive
- Detected by Claude based on user context
- No manual user input required

### Privacy First
- All data encrypted in transit
- User controls notification preferences
- Events expire automatically
